<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CareBuddy – Conversation UI</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    .app-container {
      max-width: 1300px;
      margin: 20px auto;
      background: #ffffff;
      border: 1px solid #ddd;
      padding: 16px 20px 20px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 22px;
      margin: 0 0 4px;
    }

    .subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 12px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .status {
      font-size: 12px;
      color: #555;
      margin-left: auto;
    }

    .session-id {
      font-size: 11px;
      color: #999;
      margin-top: 2px;
    }

    /* === MAIN SPLIT LAYOUT === */
    .main-split {
      display: flex;
      gap: 16px;
      margin-top: 12px;
    }

    /* LEFT = Metrics + Charts */
    .left-side {
      width: 420px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 650px;
      overflow-y: auto;
    }

    /* RIGHT = CHAT PANEL */
    .right-side {
      flex: 1;
      min-width: 55%;
      display: flex;
      flex-direction: column;
    }

    .side-panel {
      padding: 12px;
      border: 1px solid #ddd;
      background: #ffffff;
      display: none;
      border-radius: 4px;
    }

    /* Chat messages */
    .chat-container {
      border: 1px solid #ddd;
      background: #fafafa;
      height: 460px;
      padding: 10px;
      overflow-y: auto;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    .msg-row {
      margin-bottom: 8px;
    }

    .msg-meta {
      font-size: 11px;
      color: #777;
      margin-bottom: 2px;
    }

    .msg-bubble {
      display: inline-block;
      padding: 6px 8px;
      border-radius: 3px;
      font-size: 14px;
      line-height: 1.4;
      border: 1px solid #ddd;
      background: #fff;
      max-width: 100%;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .msg-user .msg-bubble {
      background: #e6f2ff;
      border-color: #c7ddff;
    }

    .msg-assistant .msg-bubble {
      background: #f7f7f7;
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    textarea {
      flex: 1;
      resize: vertical;
      min-height: 40px;
      max-height: 120px;
      font-size: 14px;
      padding: 6px;
      box-sizing: border-box;
    }

    button {
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #f0f0f0;
    }

    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 12px;
      color: #666;
    }

    .error-text {
      color: #b00020;
      font-size: 12px;
      margin-top: 4px;
    }

    /* === PRETTY METRICS PANEL === */

    .metrics-grid {
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .metric-section-title {
      font-weight: 600;
      font-size: 14px;
      margin-top: 6px;
      padding-bottom: 3px;
      border-bottom: 1px solid #ddd;
      color: #444;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }

    .metric-row span:first-child {
      color: #444;
    }

    .metric-row span:last-child {
      font-weight: 600;
      color: #222;
    }

    /* Final score box */
    .metric-final {
      margin-top: 6px;
      padding: 8px;
      background: #f7faff;
      border: 1px solid #cfdffd;
      border-radius: 4px;
    }

    .metric-final-score,
    .metric-final-raw,
    .metric-final-quality {
      margin: 2px 0;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }

    /* Color-coded quality values */
    .metric-final-quality span {
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .quality-high {
      background: #d4f8e3;
      color: #267a46;
    }

    .quality-med {
      background: #fff4c2;
      color: #927400;
    }

    .quality-low {
      background: #ffd6d6;
      color: #a33a3a;
    }
  </style>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
  <div class="app-container">
    <h1>CareBuddy Conversation UI</h1>
    <div class="subtitle">
      Local LLM evaluation interface – conversations are stored for later metric analysis.
    </div>

    <div class="top-bar">
      <div>
        <label for="chat-version-select">Chat version:</label>
        <select id="chat-version-select">
          <option value="model-1">model-1 (v1)</option>
          <option value="model-2">model-2 (v2)</option>
          <option value="model-3">model-3 (v3)</option>
          <option value="model-4">model-4 (v4)</option>
        </select>
      </div>

      <div class="status">
        Backend: <span id="status-text">idle</span>
      </div>
    </div>

    <div class="session-id">
      Session: <span id="session-id-text">– starting… –</span>
    </div>

    <!-- SPLIT SCREEN LAYOUT -->
    <div class="main-split">

      <!-- LEFT SIDE = METRICS + CHARTS -->
      <div class="left-side">

        <!-- METRICS PANEL -->
        <div id="metrics-panel" class="side-panel">
          <h3 style="margin-top: 0;">Conversation Analysis</h3>

          <div id="metrics-content" class="metrics-grid">

            <div class="metric-section-title">Model Information</div>
            <div class="metric-row"><span>Model:</span><span id="mc-model"></span></div>
            <div class="metric-row"><span>Session:</span><span id="mc-session"></span></div>

            <div class="metric-section-title">Raw Metrics</div>
            <div class="metric-row"><span>Contextual Recall:</span><span id="mc-cr-raw"></span></div>
            <div class="metric-row"><span>Conversational Flow:</span><span id="mc-flow-raw"></span></div>
            <div class="metric-row"><span>Latency (ms):</span><span id="mc-lat-raw"></span></div>
            <div class="metric-row"><span>Turn Balance (TCB):</span><span id="mc-tcb-raw"></span></div>
            <div class="metric-row"><span>Utterance Length:</span><span id="mc-ul-raw"></span></div>

            <div class="metric-section-title">Normalized Metrics</div>
            <div class="metric-row"><span>Contextual Recall:</span><span id="mc-cr-norm"></span></div>
            <div class="metric-row"><span>Conversational Flow:</span><span id="mc-flow-norm"></span></div>
            <div class="metric-row"><span>Latency:</span><span id="mc-lat-norm"></span></div>
            <div class="metric-row"><span>Turn Balance:</span><span id="mc-tcb-norm"></span></div>
            <div class="metric-row"><span>Utterance Length:</span><span id="mc-ul-norm"></span></div>

            <div class="metric-section-title">Final Score</div>
            <div class="metric-final">
              <div class="metric-final-score"><span>Score:</span><span id="mc-final-score"></span></div>
              <div class="metric-final-raw"><span>Raw Score:</span><span id="mc-final-score-raw"></span></div>
              <div class="metric-final-quality"><span>Quality:</span><span id="mc-quality"></span></div>
            </div>

          </div>
        </div>

        <!-- CHARTS PANEL -->
        <div id="charts-panel" class="side-panel">
          <h3 style="margin-top:0;">Conversation Charts</h3>

          <div style="margin-bottom: 20px;">
            <h4>Radar Chart</h4>
            <canvas id="radarChart" height="180"></canvas>
          </div>

          <div style="margin-bottom: 20px;">
            <h4>Normalized Metrics</h4>
            <canvas id="normalizedBarChart" height="180"></canvas>
          </div>

          <div style="margin-bottom: 20px;">
            <h4>Raw Metrics</h4>
            <canvas id="rawBarChart" height="180"></canvas>
          </div>
        </div>

      </div>

      <!-- RIGHT SIDE = CHAT UI -->
      <div class="right-side">
        <div id="chat" class="chat-container"></div>

        <div class="input-row">
          <textarea id="user-input" placeholder="Type your message and press Enter..."></textarea>
          <button id="send-btn">Send</button>
        </div>

        <div class="bottom-bar">
          <div id="error-area" class="error-text"></div>
          <div class="actions-right">
            <button id="new-session-btn">New session</button>
            <button id="analyze-btn">Analyze conversation</button>
          </div>
        </div>
      </div>

    </div> <!-- END SPLIT -->
  </div>

  <!-- ================= JS SECTION ================== -->
  <script>
    const API_URL = "http://127.0.0.1:8000/v1/chatremote";

    const chatEl = document.getElementById("chat");
    const userInputEl = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const chatVersionSelectEL = document.getElementById("chat-version-select");
    const statusTextEl = document.getElementById("status-text");
    const sessionIdTextEl = document.getElementById("session-id-text");
    const errorAreaEl = document.getElementById("error-area");
    const newSessionBtn = document.getElementById("new-session-btn");
    const analyzeBtn = document.getElementById("analyze-btn");

    let radarChart = null;
    let normalizedBarChart = null;
    let rawBarChart = null;

    let displayMessages = [];

    function generateSessionId() {
      return crypto.randomUUID();
    }

    function setSessionId(id) {
      sessionStorage.setItem("carebuddy_session_id", id);
      sessionIdTextEl.textContent = id;
    }

    function getSessionId() {
      let sid = sessionStorage.getItem("carebuddy_session_id");
      if (!sid) {
        sid = generateSessionId();
        setSessionId(sid);
      }
      return sid;
    }

    function clearSessionId() {
      sessionStorage.removeItem("carebuddy_session_id");
      sessionIdTextEl.textContent = "– not started yet –";
    }

    function addMessageToDisplay(role, content) {
      displayMessages.push({
        role,
        content,
        timestamp: new Date().toISOString(),
      });
      renderChat();
    }

    function renderChat() {
      chatEl.innerHTML = "";
      displayMessages.forEach(msg => {
        const row = document.createElement("div");
        row.className = "msg-row " + (msg.role === "user" ? "msg-user" : "msg-assistant");

        const meta = document.createElement("div");
        meta.className = "msg-meta";
        meta.textContent = `${msg.role.toUpperCase()} – ${new Date(msg.timestamp).toLocaleTimeString()}`;

        const bubble = document.createElement("div");
        bubble.className = "msg-bubble";
        bubble.textContent = msg.content;

        row.appendChild(meta);
        row.appendChild(bubble);
        chatEl.appendChild(row);
      });

      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setLoading(isLoading) {
      statusTextEl.textContent = isLoading ? "sending..." : "idle";
      sendBtn.disabled = isLoading;
    }

    async function sendMessage() {
      errorAreaEl.textContent = "";

      const text = userInputEl.value.trim();
      if (!text) return;

      const chat_version = chatVersionSelectEL.value;
      const sessionId = getSessionId();

      addMessageToDisplay("user", text);
      userInputEl.value = "";

      const payload = {
        model: "",
        chat_version: chat_version,
        messages: [{ role: "user", content: text }],
        session_id: sessionId
      };

      setLoading(true);

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errText}`);
        }

        const data = await res.json();

        if (data.session_id) {
          setSessionId(data.session_id);
        }

        const reply =
          data.choices?.[0]?.message?.content ??
          "[No content returned]";

        addMessageToDisplay("assistant", reply);
      } catch (err) {
        errorAreaEl.textContent = "Error: " + err.message;
      } finally {
        setLoading(false);
      }
    }

    function resetFullSession() {
  // 1. Reset session ID
  clearSessionId();
  const newId = generateSessionId();
  setSessionId(newId);

  // 2. Clear chat messages
  displayMessages = [];
  renderChat();

  // 3. Hide metrics & charts
  document.getElementById("metrics-panel").style.display = "none";
  document.getElementById("charts-panel").style.display = "none";

  // 4. Destroy Chart.js instances if they exist
  if (radarChart) { radarChart.destroy(); radarChart = null; }
  if (normalizedBarChart) { normalizedBarChart.destroy(); normalizedBarChart = null; }
  if (rawBarChart) { rawBarChart.destroy(); rawBarChart = null; }

  // 5. Clear error message (if any)
  errorAreaEl.textContent = "";

  // 6. Status message update
  statusTextEl.textContent = "idle";

  displayMessages = [];
}


    async function analyzeConversation() {
      const model = chatVersionSelectEL.value;
      const sessionId = getSessionId();

      if (!sessionId) {
        alert("No active session.");
        return;
      }

      const url = `http://127.0.0.1:8000/v1/analyze/${model}/${sessionId}`;

      errorAreaEl.textContent = "";
      setLoading(true);

      try {
        const res = await fetch(url, { method: "GET" });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();

        renderMetrics(data);
        renderCharts(data);
      } catch (err) {
        errorAreaEl.textContent = "Analysis error: " + err.message;
      } finally {
        setLoading(false);
      }
    }

    function renderMetrics(data) {
      document.getElementById("metrics-panel").style.display = "block";

      const raw = data.metrics_raw;
      const norm = data.metrics_normalized;

      document.getElementById("mc-model").textContent = data.model_id;
      document.getElementById("mc-session").textContent = data.session_id;

      document.getElementById("mc-cr-raw").textContent = raw.ContextualRecall.toFixed(3);
      document.getElementById("mc-flow-raw").textContent = raw.ConversationalFlow.toFixed(3);
      document.getElementById("mc-lat-raw").textContent = raw.Latency.toFixed(1);
      document.getElementById("mc-tcb-raw").textContent = raw.TurnBalance.TCB.toFixed(3);
      document.getElementById("mc-ul-raw").textContent = raw.UtteranceLength.UL_mean.toFixed(3);

      document.getElementById("mc-cr-norm").textContent = norm.ContextualRecall.toFixed(3);
      document.getElementById("mc-flow-norm").textContent = norm.ConversationalFlow.toFixed(3);
      document.getElementById("mc-lat-norm").textContent = norm.Latency.toFixed(3);
      document.getElementById("mc-tcb-norm").textContent = norm.TurnBalance.toFixed(3);
      document.getElementById("mc-ul-norm").textContent = norm.UtteranceLength.toFixed(3);

      document.getElementById("mc-final-score").textContent = data.final_score.toFixed(4);
      document.getElementById("mc-final-score-raw").textContent = data.final_score_raw.toFixed(4);

      const q = data.quality;
      const qEl = document.getElementById("mc-quality");
      qEl.textContent = q;

      qEl.classList.remove("quality-high", "quality-med", "quality-low");

      if (q === "High") qEl.classList.add("quality-high");
      else if (q === "Medium") qEl.classList.add("quality-med");
      else qEl.classList.add("quality-low");
    }

    function renderCharts(data) {
      const chartsPanel = document.getElementById("charts-panel");
      chartsPanel.style.display = "block";

      const norm = data.metrics_normalized;
      const raw = data.metrics_raw;

      const labels = [
        "Contextual Recall",
        "Conversational Flow",
        "Latency",
        "Turn Balance",
        "Utterance Length"
      ];

      const normalizedValues = [
        norm.ContextualRecall,
        norm.ConversationalFlow,
        norm.Latency,
        norm.TurnBalance,
        norm.UtteranceLength
      ];

      const rawValues = [
        raw.ContextualRecall,
        raw.ConversationalFlow,
        raw.Latency,
        raw.TurnBalance.TCB,
        raw.UtteranceLength.UL_mean
      ];

      if (radarChart) radarChart.destroy();
      if (normalizedBarChart) normalizedBarChart.destroy();
      if (rawBarChart) rawBarChart.destroy();

      const radarCtx = document.getElementById("radarChart").getContext("2d");
      radarChart = new Chart(radarCtx, {
        type: "radar",
        data: {
          labels: labels,
          datasets: [{
            label: "Normalized",
            data: normalizedValues,
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 2
          }]
        },
        options: {
          scales: { r: { min: 0, max: 1 } }
        }
      });

      const normalizedCtx = document.getElementById("normalizedBarChart").getContext("2d");
      normalizedBarChart = new Chart(normalizedCtx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Normalized",
            data: normalizedValues,
            backgroundColor: "rgba(75, 192, 192, 0.5)",
            borderColor: "rgba(75, 192, 192, 1)",
            borderWidth: 1
          }]
        },
        options: { scales: { y: { beginAtZero: true, max: 1 } } }
      });

      const rawCtx = document.getElementById("rawBarChart").getContext("2d");
      rawBarChart = new Chart(rawCtx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Raw",
            data: rawValues,
            backgroundColor: "rgba(255, 159, 64, 0.5)",
            borderColor: "rgba(255, 159, 64, 1)",
            borderWidth: 1
          }]
        }
      });
    }

    sendBtn.addEventListener("click", sendMessage);

    userInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    newSessionBtn.addEventListener("click", () => {
      if (displayMessages.length > 0 &&
      !confirm("Start a new session? Current chat will remain on screen but backend will use a new session_id.")) {
    return;
  }
  clearSessionId();
  const newId = generateSessionId();
  setSessionId(newId);
  displayMessages = [];
  renderChat();
    });

    analyzeBtn.addEventListener("click", analyzeConversation);

    chatVersionSelectEL.addEventListener("change", () => {
      resetFullSession();
    });
    const sid = getSessionId();
    sessionIdTextEl.textContent = sid;
  </script>
</body>
</html>
